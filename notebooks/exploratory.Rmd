---
title: "GAS simulations: number of goals and attainment levels"
subtitle: "Exploratory analysis"
author: "Taylor Dunn"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    df_print: paged
    toc: TRUE
    toc_float: TRUE
    theme: paper
    highlight: zenburn
bibliography: ../references.bib
---
<style>
body .main-container {
  max-width: 1500px !important;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  fig.width = 6, fig.height = 4, dpi = 150
)
```

```{r packages, include=FALSE}
library(tidyverse)
library(here)
library(ardea)
library(targets)
library(gt)
library(glue)

extrafont::loadfonts(device = "win", quiet = TRUE)
set_ardea_defaults()
```

# Motivation

From Chapter 10 of @Kiresuk1993, page 215, on the topic of 5-point scales versus 3-point scales:

>Although it is natural to prefer more reliable scale scores whenever possible, the overriding concern must be the reliability of the summary GAS score.
>Increasing the number of scales on a follow-up guide will also increase the reliability of the GAS score (cf. Epstein, 1980).
>Conceivably one could achieve the same reliability with a larger number of 3-point scales than with fewer 5-point scales.

>To make an informed choice one needs to know both how many extra 3-point scales must be constructed to reach parity with the 5-point scales and also the practical implications of such a strategy.
>One approach to the former requires consideration of the number of distinct values of the summary GAS score that can be generated under each alternative.
>Each 5-point scale can produce any one of five distinct values (e.g. -2, -1, 0, +1, or +2).
>With three such scales, the sum of the scale coulds could be any integer value from -6 to +6, a range that includes 13 distinct values.
>Thus any summary GAS score based upon the sum, or average, of the scale scores could take on only 13 distinct values so that the summary score is essentially a 13-point scale.
>The reader should note that it does not matter what scoring system is used for the scale scores.
>Whether scales are scored from -2 to +2, from 1 to 5, or from 10 to 50 does not matter; three 5-point scales will produce summary scores on a 13-point scale.

>The question now becomes how many 3-point scales are required to produce a 13-point summary score.
>The 3-point scales can yield any one of just three possible scores that, for convenience, we assume to be -1, 0, or +2.
>For the summary score to have 13 possible distinct values, the sum of the individual scale scores again must be able to take on any integer value from -6 to +6.
>Obviously, that condition does not occur unless we have six 3-point scales, exactly twice the number of 5-point scales.
>In fact, it can be shown that twice as many 3-point scales will always be required to achieve this type of parity with 5-point scales.

To check this logic, the below table shows the number of possible summary scores with 1-8 goals and with 3, 5 or 7-point scales:

```{r}
d <- crossing(
  n_goals = 1:8,
  n_levels = c(3, 5, 7)
) %>%
  rowwise() %>%
  mutate(
    summary_values = map2_int(
      n_goals, n_levels,
      ~{
        min_score <- n_goals
        max_score <- n_goals * n_levels
        
        as.integer(max_score - min_score + 1)
      }
    )
  ) %>%
  ungroup()
d %>%
  pivot_wider(names_from = n_levels, values_from = summary_values) %>%
  gt() %>%
  gt::tab_spanner(
    label = "Number of attainment levels",
    columns = c(`3`, `5`, `7`)
  ) %>%
  gt::data_color(
    columns = c(`3`, `5`, `7`),
    colors = scales::col_numeric(ardea::ardea_pal("purple_blue")(2),
                                 domain = c(min(d$summary_values),
                                            max(d$summary_values)))
  )
```


# Analysis

Load the data:

```{r}
#tar_load(sim_data_ttest)
tar_load(sim_data_power)
```

Pre-process:

```{r}
sim_data_power <- sim_data_power %>%
  mutate(
    n_subjects_delta = glue("{n_subjects} subjects, delta = {delta}"),
    power_label = scales::percent(power, accuracy = 1),
    n_goals_n_levels = glue("{n_goals} goals, {n_levels} levels"),
    n_possible_values = n_goals * (n_levels - 1) + 1
  )
```


The parameter combinations that were simulated:

```{r}
sim_data_power %>%
  select(n_goals, n_levels, n_subjects, delta, n_sim) %>%
  gt() %>%
  tab_options(container.height = 300,
              container.overflow.y = TRUE)
```

Visualize the power for each combination:

```{r fig.width=10, fig.height=6}
sim_data_power %>%
  ggplot(aes(x = factor(n_goals), y = factor(n_levels))) +
  geom_tile(aes(fill = power)) +
  geom_text(aes(label = power_label), color = "white") +
  facet_wrap(~n_subjects_delta, ncol = 3) +
  theme(legend.position = "none") +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  labs(x = "Number of goals per subject",
       y = "Number of attainment levels")
```

```{r fig.width=8, fig.height=6}
sim_data_power %>%
  ggplot(aes(x = n_goals, y = power, color = factor(n_levels))) +
  geom_point() +
  geom_line() +
  scale_y_continuous(
    "Power",
    breaks = seq(0, 1, 0.2),
    limits = c(0, 1), labels = scales::percent_format(1)
  ) +
  scale_x_continuous(
    "Number of goals per subject",
    breaks = seq(1, 7, 2)
  ) +
  labs(color = "Number of attainment levels") +
  facet_wrap(~n_subjects_delta, ncol = 3) +
  theme(legend.position = "top")
```

Same as above, but plot the difference in power relative to 5 attainment levels:

```{r fig.width=8, fig.height=6}
sim_data_power %>%
  group_by(n_subjects_delta, n_goals) %>%
  mutate(power_diff = power - power[n_levels == 5]) %>%
  ggplot(aes(x = n_goals, y = power_diff, color = factor(n_levels))) +
  geom_point() +
  geom_line() +
  scale_y_continuous(
    "Power difference from 5 attainment levels",
    labels = scales::percent_format(1)
  ) +
  scale_x_continuous(
    "Number of goals per subject",
    breaks = seq(1, 7, 2)
  ) +
  labs(color = "Number of attainment levels") +
  facet_wrap(~n_subjects_delta, ncol = 3) +
  theme(legend.position = "top")
```

Put these power differences into a table:

```{r fig.width=10, fig.height=6}
d <- sim_data_power %>%
  group_by(n_subjects_delta, n_goals) %>%
  mutate(power_diff = power - power[n_levels == 5]) %>%
  ungroup() %>%
  mutate(
    power_diff_label = ifelse(
      n_levels == 5,
      scales::percent(power, accuracy = 1),
      scales::percent(power_diff, accuracy = 1)
    ),
    # Put a "+" sign on power gains
    power_diff_label = ifelse(
      n_levels != 5 & power_diff > 0.0,
      str_c("+", power_diff_label), power_diff_label
    )
  )
d %>%
  ggplot(aes(x = factor(n_goals), y = factor(n_levels))) +
  geom_tile(aes(fill = power_diff)) +
  geom_text(aes(label = power_diff_label), color = "white") +
  facet_wrap(~n_subjects_delta, ncol = 3) +
  theme(legend.position = "none") +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  labs(x = "Number of goals per subject",
       y = "Number of attainment levels")
   
```

```{r fig.width=8, fig.height=6, eval=FALSE, echo=FALSE}
# How does this look when we combine number of goals and number of attainment levels into *number of possible summary scores*:

sim_data_power %>%
  ggplot(aes(x = n_possible_values, y = power, color = factor(n_levels),
             group = n_goals)) +
  geom_point() +
  geom_line() +
  scale_y_continuous(
    "Power",
    breaks = seq(0, 1, 0.2),
    #limits = c(0, 1),
    labels = scales::percent_format(1)
  ) +
  scale_x_continuous(
    "Number of possible summary scores",
  ) +
  labs(color = "Number of attainment levels") +
  facet_wrap(~n_subjects_delta, ncol = 3, scales = "free_y") +
  theme(legend.position = "top")
```


# Reproducibility

<details><summary>Reproducibility receipt</summary>

```{r}
Sys.time()
```

```{r}
if ("git2r" %in% installed.packages()) {
  if (git2r::in_repository()) {
    git2r::repository()
  }
}
```

```{r}
sessioninfo::session_info()
```

</details>

# References
